"use strict";angular.module("wrdz",["ngCookies","ngResource","ngSanitize","ngRoute","mgo-mousetrap","perfect_scrollbar","ui.router"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c}]),angular.module("wrdz").config(["$stateProvider","$urlRouterProvider",function(a){a.state("signup",{url:"/signup",templateUrl:"partials/signup.html",controller:["$scope","$state","User",function(a,b,c){a.signup=function(d){c.isLoggedIn()||c.signup(d).success(function(a){c.changeUser(a),b.go("read")}).error(function(b){console.log(b.errors.email.type),a.message="Something went wrong...someone probably already has that email on here."})}}]}).state("signin",{url:"/signin",templateUrl:"partials/signin.html",controller:["$scope","$state","User",function(a,b,c){a.signin=function(d){c.isLoggedIn()||c.signin(d).success(function(a){c.changeUser(a),b.go("read")}).error(function(b){"Unknown user"==b&&(a.message="No user with that email."),"Invalid password"==b&&(a.message="Right email, wrong password, need link to change password here")})}}]}).state("landing",{url:"/",templateUrl:"partials/landing.html"}).state("read",{url:"/read",templateUrl:"partials/read.html"}).state("read-doc",{url:"/r/:docId",templateUrl:"partials/read-doc.html",controller:["$scope","$stateParams","$state","Read",function(a,b,c,d){var e=b.docId;d.getPubDoc(e).then(function(b){a.readDoc=b.data}),a.heart=function(){d.updatePubDoc(e,"heart")},a.up_vote=function(){d.updatePubDoc(e,"up_vote")},a.view=function(){d.updatePubDoc(e,"view")},a.view()}]}).state("write",{url:"/write",templateUrl:"partials/write.html"}).state("profile",{url:"/profile",templateUrl:"partials/me.html"}).state("profile.about",{url:"/about",templateUrl:"partials/about.html"}).state("talk",{url:"/talk",templateUrl:"partials/talk.html"})}]),angular.module("wrdz").controller("NavbarCtrl",["$scope","$state","User",function(){}]),angular.module("wrdz").controller("MainCtrl",["$scope","User","$rootScope",function(a,b){function c(){var a=b.isLoggedIn();a&&!a.messages&&b.getCurrentUser(a._id).success(function(a){b.changeUser(a.user)}).error(function(a){console.log(a)})}c(),a.$on("userChange",function(b,c){a.user=c?c:null})}]),angular.module("wrdz").factory("User",["$http","$cookieStore","$rootScope",function(a,b,c){function d(a){e=a,c.$broadcast("userChange",a)}var e=b.get("user")||null;return b.remove("user"),{changeUser:d,isLoggedIn:function(){return e?e:null},signup:function(b){return a.post("/signup",b)},signin:function(b){return a.post("/login",b)},logout:function(){return a.get("/logout")},update:function(){a.post("/updateuser",e).success(function(){}).error()},user:e,getCurrentUser:function(b){return a.get("users/"+b)},feedback:function(b){a.post("/feedback",b).success(function(){console.log("Feedback success")}).error(function(){console.log("Feedback error")})}}}]),angular.module("wrdz").directive("mediumEditor",["$timeout",function(a){return{require:"ngModel",restrict:"AE",link:function(b,c,d,e){angular.element(c).addClass("angular-medium-editor");var f={};d.options&&(f=angular.fromJson(d.options));var g=f.placeholder||"Type here";c.on("blur keypress keydown keyup change",function(){b.$apply(function(){if("<p><br></p>"==c.html()||""==c.html()||"<br>"==c.html()){f.placeholder=g;{new MediumEditor(c,f)}}a(function(){e.$setViewValue(c.html())},100)})}),e.$render=function(){if(!a){e.$isEmpty(e.$viewValue)?d.$set("data-placeholder",angular.fromJson(d.options).placeholder):(console.log("not empty so no placeholder"),f.placeholder="",d.$set("data-placeholder","")),console.log("making editor");var a=new MediumEditor(c,f)}c.html(e.$isEmpty(e.$viewValue)?"":e.$viewValue)}}}}]),angular.module("wrdz").controller("WriteCtrl",["$scope","User","Write","Profile","$state","$timeout",function(a,b,c){function d(a,b){var c=!0;return angular.forEach(b,function(b){b.title==a.title&&(c=!1)}),c}function e(){document.getElementById("write-content").focus()}a.currentDoc=c.getCurrentDoc(),a.user&&c.setCurrentDoc(a.user.current_doc),a.$on("userChange",function(b,d){d?d.current_doc?c.setCurrentDoc(d.current_doc):(console.log("No current Doc"),a.noDoc=!0):a.noUser=!0}),a.$watch("currentDoc.title",function(b){(b||""==b)&&c.updateUserDoc("title",a.currentDoc.title)}),a.$watch("currentDoc.body",function(b){b&&c.updateUserDoc("body",a.currentDoc.body)}),a.$watch(c.getCurrentDoc,function(b){b&&(a.currentDoc=b)}),a.publish=function(b){c.publishDoc(b,a.user),a.currentDoc.is_published=!0},a.switchDoc=function(b){c.setCurrentDoc(b),c.updateCurrentDoc(b._id,a.user),a.user.current_doc=b},a.newDoc=function(){c.createNewDoc().then(function(b){var d=b.data;c.setCurrentDoc(d),c.updateCurrentDoc(d._id,a.user),a.user._userDocs.unshift(d),a.noDoc=!1,e()})},a.newTag=function(b){if(b){a.newTagTitle="";var e=a.currentDoc._id,f=b;c.newTag(f,e,a.user).then(function(b){d(b.data,a.currentDoc.tags)&&a.currentDoc.tags.push(b.data)})}},a.removeTag=function(b){c.removeTag(b,a.currentDoc._id,a.user);for(var d=0;d<a.currentDoc.tags.length;d++)a.currentDoc.tags[d]._id==b&&a.currentDoc.tags.splice(d,1)}}]),angular.module("wrdz").factory("Write",["$http",function(a){function b(a){d=a}function c(){return d}var d={};return{getCurrentDoc:c,setCurrentDoc:b,createNewDoc:function(){return a.get("/userDocs")},updateUserDoc:function(b,c){var e={type:b,data:c};return a.post("/userDocs/"+d._id,e)},publishDoc:function(b,c){var e={doc:{title:d.title,body:d.body},id:d._id};return b?(e.doc.is_anon=!0,e.doc.author="Anonymous"):(e.doc.is_anon=!1,e.doc.author=c.username),a.post("/pubDocs",e)},updateCurrentDoc:function(b,c){var d={type:"current_doc",docId:b};return a.post("/users/"+c._id,d)},newTag:function(b,c,d){var e={type:"addTag",tag:{title:b,_docs:[c],_owner:d._id}};return a.post("/users/"+d._id,e)},removeTag:function(b,c,d){var e={type:"removeTag",tag:{_id:b},doc_id:c};return a.post("/users/"+d._id,e).then(function(a){console.log(a)})}}}]),angular.module("wrdz").factory("Read",["$http",function(a){var b=[];return{getDocs:function(){return b},refreshDocs:function(){a.get("pubDocs/").success(function(a){b=a}).error()},getPubDoc:function(b){return a.get("pubDocs/"+b)},updatePubDoc:function(b,c){var d={type:c};return a.post("/pubDocs/"+b,d)}}}]),angular.module("wrdz").controller("ReadCtrl",["$scope","Read","$state",function(a,b){a.moment=moment,b.refreshDocs(),a.isHeart=function(){},a.user&&(a.seen=a.user.meta._views),a.$on("userChange",function(b,c){c&&(a.seen=a.user.meta._views)}),a.docs=b.getDocs(),a.$watch(b.getDocs,function(b){b&&(console.log("loading new docs"),a.docs=b)})}]),angular.module("wrdz").controller("ProfileCtrl",["$scope","User","Profile","$state",function(a,b,c,d){a.user&&c.setDocIds(a.user._userDocs),a.currentDocs=[],a.docIds=[],a.$on("userChange",function(a,b){b?c.setDocIds(b._userDocs):(c.setDocIds([]),c.setDocs([]))}),a.$watch(function(){return c.getDocs()},function(b){b&&(a.currentDocs=b)}),a.$watch(function(){return c.getDocIds()},function(b){b&&(a.docIds=b,c.getDocServer_20())}),a.logout=function(){b.isLoggedIn()&&b.logout().success(function(a){b.changeUser(null),"Logged out now."==a&&d.go("landing")}).error(function(a){console.log(a)})}}]),angular.module("wrdz").factory("Profile",["$http",function(a){var b=[],c=[];return{getDocIds:function(){return b},setDocIds:function(a){b=a},pushDocId:function(a){b.push(a)},getDocs:function(){return c},setDocs:function(a){c=a},getDocServer_20:function(){var d=b.slice(-20);angular.forEach(d,function(b){a.get("userDocs/"+b).success(function(a){c.push(a)})})}}}]);
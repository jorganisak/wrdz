"use strict";angular.module("vendor",["ngCookies","ngResource","ngAnimate","ngSanitize","ngRoute","ui.bootstrap","ui.router","pickadate"]),angular.module("read",[]),angular.module("write",[]),angular.module("myWrdz",[]),angular.module("models",[]),angular.module("me",[]),angular.module("shared",[]),angular.module("wrdz",["vendor","read","write","myWrdz","me","read","models","shared"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c}]),angular.module("shared").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("landing",{url:"/",templateUrl:"partials/landing.html",controller:["$scope","$state",function(a,b){a.user&&b.go("write"),a.$on("userChange",function(a,c){c&&b.go("write")})}]}).state("twitter",{url:"/auth/twitter",templateUrl:"partials/landing.html",controller:["$scope","$timeout",function(a,b){b(function(){location.reload(!0)},100)}]}).state("read",{url:"/r",templateUrl:"partials/read.html","abstract":"true"}).state("read.front",{url:"/f?sort",templateUrl:"partials/read-list-center.html",resolve:{docs:["Read","$stateParams",function(a){return a.getDocs()}]},controller:["$scope","docs","Read","$state","$stateParams",function(a,b,c,d,e){a.hideStats=!0,a.showUser=!1,a.docs=b.data,a.$watch("readFilter",function(a){a&&(a!==e.sort&&(e.skip=null),d.go("read.list.front",{skip:e.skip,sort:a}))}),a.readFilter=e.sort}]}).state("read.user",{templateUrl:"partials/read-list-center.html",url:"/u/:userId?sort",resolve:{docs:["$stateParams","Read",function(a,b){return a.userId?b.getUser(a.userId):!1}]},controller:["$scope","docs","Read","$stateParams","$state","$rootScope",function(a,b,c,d,e){a.docs=b.data,a.docs[0]&&a.docs[0].author._id===d.userId&&a.$emit("author_info",a.docs[0].author),a.$watch("readFilter",function(a){a&&(a!==d.sort&&(d.skip=null),e.go("read.list.user",{userId:d.userId,skip:d.skip,sort:a}))}),a.readFilter=d.sort}]}).state("read.doc",{url:"/:docId",templateUrl:"partials/read-doc.html",resolve:{readDoc:["Read","$stateParams",function(a,b){return a.getPubDoc(b.docId)}]},controller:["$scope","readDoc","PubDoc","$rootScope",function(a,b){a.doc=b.data}]}).state("write",{url:"/w",templateUrl:"partials/write.html"}).state("me",{url:"/m",templateUrl:"partials/me.html"}).state("password_reset",{url:"/password_reset?key",templateUrl:"partials/password-reset.html",resolve:{email:["$cookieStore","$stateParams",function(a,b){var c=a.get("pwreset");if(c){var d=c.id.slice(0,-2),e=c.email,f=b.key;if(d===f)return a.remove("pwreset"),e}return!1}]},controller:["$scope","email","User","$state","$timeout",function(a,b,c,d,e){b||(a.emailFail=!0),a.resetPass=function(d){c.resetPassword(b,d).then(function(b){console.log(b),e(function(){a.launchLogIn()},1e3)})}}]})}]),angular.module("shared").controller("MainCtrl",["$scope","User","$modal","$window","$timeout",function(a,b,c,d){function e(){var a=b.getUser();a&&!a._userDocs&&b.getCurrentUser(a._id).success(function(a){b.changeUser(a.user)}).error(function(){})}a.pageTitle="wrdz",a.landingCopy="<h4 style='text-align:center'>Welcome to Wrdz</h4><p><br></p><p><span style='font-size: 22px; line-height: 1.25;'>This is a web app that provides a simple and clean place to write. <br><br> <strong>(Try highlighting this text.)</strong></span><br><br></p><p><em>With Wrdz, you can:&nbsp;</em></p><p></p><ul><li>Write whatever's in your head</li><li>Easily browse and organize by date and tag</li><li>Share your writing, anonymously if you'd like</li></ul>",a.mediumEditorOptionsBody=angular.toJson({placeholder:"",buttons:["bold","italic","anchor","header2","orderedlist","unorderedlist"],buttonLabels:{header2:"<b>H</b>",anchor:"<span><span class='icon ion-link'></span></span>",bold:"<strong>B</strong>",italic:"<em>i</em>"},disableToolbar:!1,forcePlainText:!1,targetBlank:!0}),e(),a.$on("userChange",function(b,c){a.user=c?c:null}),a.goToTop=function(){d.scrollTo(0,0)},a.local_auth_form=!1,a.bodyClick=function(){a.$broadcast("bodyClick")},a.launchEmailLogin=function(){c.open({templateUrl:"partials/email-login.html",controller:["$scope","$modalInstance","User",function(a,b,d){a.close=function(){b.close()},a.signin=function(b){d.isLoggedIn()||d.signin(b).success(function(b){d.getCurrentUser(b._id).success(function(b){d.changeUser(b.user),a.close(),a.$state.go("write")}).error(function(){})}).error(function(b){"Unknown user"==b&&(a.message="No one has that username on wrdz!"),"Invalid password"==b&&(a.message="Right username, wrong password...")})},a.signup=function(b){d.isLoggedIn()||d.signup(b).success(function(b){d.getCurrentUser(b._id).success(function(b){d.changeUser(b.user),a.close(),a.$state.go("write")}).error(function(){})}).error(function(b){"Username already exists"===b.errors.username.type&&(a.message="Bummer. That username is taken. Try another?")})},a.forgotPasswordModal=function(){c.open({templateUrl:"partials/password-modal.html",controller:["$scope","$modalInstance","$http","$cookieStore",function(a,b,c,d){a.close=function(){b.close()},a.submitEmail=function(b){c.post("/forgot",{email:b}).then(function(a){d.remove("pwreset"),d.put("pwreset",{id:a.data,email:b})}),a.close()}}]})}}]})},a.launchSignUp=function(){c.open({templateUrl:"partials/signup.html",controller:["$scope","$modalInstance","User","$http",function(a,b,d){a.close=function(){b.close()},a.signin=function(b){d.isLoggedIn()||d.signin(b).success(function(b){d.getCurrentUser(b._id).success(function(b){d.changeUser(b.user),a.close(),a.$state.go("write")}).error(function(){})}).error(function(b){"Unknown user"==b&&(a.message="No one has that username on wrdz!"),"Invalid password"==b&&(a.message="Right username, wrong password...")})},a.signup=function(b){d.isLoggedIn()||d.signup(b).success(function(b){d.getCurrentUser(b._id).success(function(b){d.changeUser(b.user),a.close(),a.$state.go("write")}).error(function(){})}).error(function(b){"Username already exists"===b.errors.username.type&&(a.message="Bummer. That username is taken. Try another?")})},a.forgotPasswordModal=function(){c.open({templateUrl:"partials/password-modal.html",controller:["$scope","$modalInstance","$http","$cookieStore",function(a,b,c,d){a.close=function(){b.close()},a.submitEmail=function(b){c.post("/forgot",{email:b}).then(function(a){d.remove("pwreset"),d.put("pwreset",{id:a.data,email:b})}),a.close()}}]})}}]})},a.aboutModal=function(){c.open({templateUrl:"partials/about-modal.html",controller:["$scope","$modalInstance","$http",function(a,b){a.close=function(){b.close()},a.feedbackModal=function(){a.close();c.open({templateUrl:"partials/feedback-modal.html",controller:["$scope","$modalInstance","$http",function(a,b,c){a.close=function(){b.close()},a.submitFeedback=function(b){console.log(b);var d={content:b};return a.close(),c.post("/feedback",d)}}]})}}]})},a.forgotPasswordModal=function(){c.open({templateUrl:"partials/password-modal.html",controller:["$scope","$modalInstance","$http","$cookieStore",function(a,b,c,d){a.close=function(){b.close()},a.submitEmail=function(b){c.post("/forgot",{email:b}).then(function(a){d.remove("pwreset"),d.put("pwreset",{id:a.data,email:b})}),a.close()}}]})}}]),angular.module("read").controller("ReadCtrl",["$scope","Read","$window","$timeout",function(a,b){a.Read=b,a.moment=moment}]).controller("ReadDocCtrl",["$scope","Read",function(a,b){function c(){a.isVote()}function d(){return a.user?!0:void a.launchSignUp()}a.isVote=function(){return a.user.meta._up_votes.indexOf(a.doc._id)>-1?(a.active1=!0,!0):(a.active1=!1,!1)},a.up_vote=function(){d()&&(a.active1===!0?(a.doc.up_votes--,a.active1=!1,b.updatePubDoc(a.doc._id,"up_vote",!1)):(a.active1=!0,b.updatePubDoc(a.doc._id,"up_vote",!0),a.doc.up_votes++))},a.user&&c(),a.$on("userChange",function(a,b){b&&c()})}]),angular.module("write").controller("WriteCtrl",["$scope","Write","$timeout","$window","$modal","Picture",function(a,b,c,d,e){a.user&&(a.user._userDocs[0]?b.setDocs(a.user._userDocs):a.user._userDocs[0]||b.createFirstDoc()),a.$on("userChange",function(c,d){d&&(b.setDocs(a.user._userDocs),a.user._userDocs[0]||b.createFirstDoc())}),a.$watchCollection(b.getDocs,function(b){b&&(a.docs=b)}),a.newDoc=function(){b.createNewDoc()},a.openTweetModal=function(b,c){e.open({templateUrl:"partials/tweet-modal.html",controller:["$scope","Write","$modalInstance","user","Picture",function(a,d,e,f,g){function h(b){console.log(a.message);var c=document.getElementById("twitter-message").value;g.tweetPic(f,b,c),a.close()}function i(a){return g.shortUrl(a)}a.user=f;var j="";a.message="",a.includePhoto=!0,a.close=function(){e.close()},a.sendTweet=function(){h(j)},b&&c&&i(b).then(function(b){var c=b.data;a.message=" "+c});var k=document.getElementById(b).offsetWidth;document.getElementById(b).style.width="320px",html2canvas(document.getElementById(b),{onrendered:function(a){document.getElementById("twitter-preview").appendChild(a),document.getElementById(b).style.width=k+"px",j=a.toDataURL("image/png")}})}],resolve:{user:function(){return a.user}}})}}]),angular.module("me").controller("MeCtrl",["$scope","User","Me","Write",function(a,b,c){a.username_ok=!0,a.change=!1,a.Me=c,a.moment=moment,a.tabs=[{title:"Profile",state:"me.profile"}],a.$watch("$scope.$state.current.name",function(b){b&&angular.forEach(a.tabs,function(a){a.active=a.state===b?!0:!1})}),a.navType="pills",a.logout=function(){b.isLoggedIn()&&b.logout().success(function(c){b.changeUser(null),"Logged out now."==c&&a.$state.go("write")}).error(function(a){console.log(a)})}}]).controller("MeSettingsCtrl",["$scope","User","Me",function(a,b,c){a.user&&(a.username_copy=angular.copy(a.user.username)),a.$on("userChange",function(b,c){c&&(a.username_copy=angular.copy(c.username))}),a.usernameChange=function(){a.username_copy;console.log,a.change=!0},a.saveUsername=function(){if(a.change&&a.username_ok){var d=c.saveUsername(a.username_copy);d.then(function(c){200===c.status&&(b.changeUser(c.data),a.change=!1)})}},a.$watch("username_copy",function(b){if(b){b===a.user.username&&(a.change=!1);var d=c.testUsername(b);d.then(function(b){a.username_ok="Username exists"===b.data.message?!1:!0})}else a.username_ok=!1},!0)}]),angular.module("shared").controller("NavCtrl",["$scope","$timeout",function(a){a.showNav=!1,a.expandNav=function(){a.showNav=a.showNav===!1?!0:!1},a.$on("bodyClick",function(){a.showNav=!1})}]),angular.module("wrdz").directive("mediumEditor",["$timeout",function(a){return{require:"ngModel",restrict:"AE",link:function(b,c,d,e){angular.element(c).addClass("angular-medium-editor");var f={};d.options&&(f=angular.fromJson(d.options));var g=f.placeholder;c.on("blur keypress keydown keyup change",function(){b.$apply(function(){if("<p><br></p>"==c.html()||""==c.html()||"<br>"==c.html()){f.placeholder=g;{new MediumEditor(c,f)}}a(function(){e.$setViewValue(c.html())},100)})}),e.$render=function(){if(!a){e.$isEmpty(e.$viewValue)?d.$set("data-placeholder",angular.fromJson(d.options).placeholder):(f.placeholder="",d.$set("data-placeholder",""));var a=new MediumEditor(c,f)}c.html(e.$isEmpty(e.$viewValue)?"":e.$viewValue)}}}}]),angular.module("shared").directive("writeUnit",function(){return{restrict:"AE",templateUrl:"partials/write-unit.html",scope:{doc:"=doc",user:"=user",tweetModal:"&tweet"},controller:["$scope","$timeout","Write",function(a,b,c){function d(){return a.doc.is_published&&a.doc.pub_doc.is_visible?!0:!1}a.mediumEditorOptionsBody=c.getMediumOptions,a.moment=moment,a.shelfCollapsed=!0,a.showDoc=!0,a.archive=function(){var d=!0;a.showArchiveWarning=!0,a.showDoc=!1,a.cancelArchive=function(){a.showDoc=!0,a.showArchiveWarning=!1,d=!1},b(function(){d&&(a.showArchiveWarning=!1,c.updateUserDoc("archive",!0,a.doc._id))},3e3)},a.publish=function(b){c.publishDoc(b,a.doc._id).then(function(b){201===b.status&&(a.doc.is_published=!0,a.doc.pub_doc=b.data)})},a.tweet=function(){a.tweetModal({docId:a.doc._id,pub:d()})},a.switchVisible=function(){c.updateUserDoc("pubVisible",!a.doc.pub_doc.is_visible,a.doc._id),a.doc.pub_doc.is_visible=!a.doc.pub_doc.is_visible},a.bodyChange=function(){b(function(){a.doc.body&&c.updateUserDoc("body",{body:a.doc.body},a.doc._id)},500)}}],link:function(){}}}).directive("twitterButton",["$window",function(){return{restrict:"AE",replace:!0,controller:["$scope","$window",function(a,b){var c=function(a){console.log("going");var c,d="https://twitter.com/intent/tweet?text=&url=http://wrdz.co/r/"+a;c={width:500,height:350},c.top=screen.height/2-c.height/2,c.left=screen.width/2-c.width/2,b.open(d,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,left="+c.left+",top="+c.top+",width="+c.width+",height="+c.height)};a.open=c}],link:function(){}}}]),angular.module("wrdz").directive("shareButton",["$window",function(){return{restrict:"AE",link:function(a,b,c){angular.element(b).addClass("share-button");var d={};c.options&&(d=angular.fromJson(c.options)),new Share(".share-button",{ui:{flyout:"bottom right"}})}}}]),angular.module("shared").filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),angular.module("write").factory("Write",["User","PubDoc","UserDoc",function(a,b,c){function d(){return l}function e(a){l=a}function f(a,b,d){return g(d),c.update(d,a,b)}function g(b){angular.forEach(a.getUser()._userDocs,function(a){a._id===b&&(a.updated_at=Date())})}function h(){var b=a.getUser();b&&c.create().then(function(a){var c=a.data;b._userDocs.unshift(c)})}function i(){var b=a.getUser();c.create().then(function(a){var c=a.data;c.body="<p>Delete this and write something awesome!</p>",b._userDocs.unshift(c)})}function j(a,c){var d={id:c,is_anon:a};return b.create(d)}var k=angular.toJson({placeholder:"Write here",buttons:["bold","italic","header2"],buttonLabels:{header2:"<b>H</b>",anchor:"<span><span class='icon ion-link'></span></span>",bold:"<strong>b</strong>",italic:"<em><b>i</b></em>"},disableToolbar:!1,cleanPastedHTML:!0,checkLinkFormat:!0,targetBlank:!0,anchorPreviewHideDelay:500}),l=[];return{createFirstDoc:i,createNewDoc:h,updateUserDoc:f,publishDoc:j,getDocs:d,setDocs:e,getMediumOptions:k}}]),angular.module("read").factory("Read",["$http","PubDoc","User","$state",function(a,b){var c=[];return{getDocs:function(){return b.list()},getUser:function(a){return b.user(a)},setDocs:function(a){c=a},getPubDoc:function(a){return b.findOne(a)},updatePubDoc:function(a,c,d){return b.update(a,c,d)}}}]),angular.module("shared").factory("Me",["$http","User",function(a,b){return{testUsername:function(a){return b.testUsername(a)},saveUsername:function(a){return b.update("username",a)}}}]),angular.module("shared").factory("Picture",["$http",function(a){return{tweetPic:function(b,c,d){var e={user:b,pic:c,message:d};a.post("/twitterPic",e).success(function(a){console.log(a)})},shortUrl:function(b){var c={url:"http://www.wrdz.co/r/"+b};return a.post("/shortenUrl",c)}}}]),angular.module("models").factory("User",["$http","$cookieStore","$rootScope",function(a,b,c){function d(a){e=a,c.$broadcast("userChange",a)}var e=b.get("user")||null;return b.remove("user"),{changeUser:d,isLoggedIn:function(){return e?!0:!1},getUser:function(){return e?e:void 0},setUser:function(a){a&&(e=a)},update:function(b,c){var d={data:c};return a.post("/users/"+e._id+"/?type="+b,d)},getCurrentUser:function(b){return a.get("users/"+b)},resetPassword:function(b,c){var d={email:b,password:c};return a.post("/reset",d)},testUsername:function(b){var c={username:b};return a.post("/usernametest",c)},signup:function(b){return a.post("/signup",b)},signin:function(b){return a.post("/login",b)},logout:function(){return a.get("/logout")},twitter:function(){return a.get("/auth/twitter")}}}]),angular.module("models").factory("UserDoc",["$http",function(a){return{create:function(){return a.post("/userDocs")},update:function(b,c,d){var e={data:d};return a.post("/userDocs/"+b+"/?type="+c,e)},list:function(b){for(var c="",d=0;d<b.length;d++)if(b[d].value instanceof Array)for(var e=0;e<b[d].value.length;e++)c=c+b[d].type+"[]="+b[d].value[e]+"&";else c=c+b[d].type+"="+b[d].value+"&";return a.get("/userDocs/?"+c)}}}]),angular.module("models").factory("PubDoc",["$http",function(a){return{create:function(b){return a.post("/pubDocs",b)},update:function(b,c,d){var e={data:d};return a.post("/pubDocs/"+b+"/?type="+c,e)},findOne:function(b){return a.get("/pubDocs/"+b)},list:function(){return a.get("/pubDocs")},user:function(b){return a.get("/pubDocs?user="+b)}}}]);